const translations = {
  es: {
    lang_label: 'Idioma',
    nav_product: 'Problema',
    nav_how: 'Cómo funciona',
    nav_who: 'Para quién',
    cta_start: 'Genera tu primer curso',
    cta_team: 'Habla con nosotros',
    cta_team_note: '¿Tienes equipo? Podemos ayudar con su capacitación.',
    hero_pill: 'Constructor de sistemas de aprendizaje',
    hero_title: 'La forma más simple de aprender lo que quieras',
    hero_subtitle: 'MiniLearn genera una ruta estructurada según tu objetivo, nivel y tiempo, y la refuerza con cápsulas diarias y evaluaciones adaptativas.',
    cta_how: 'Ver cómo funciona',
    badge_card: 'Minutos, no horas',
    badge_freemium: 'Estructurado para ti',
    badge_weekly: 'Personalizado por IA',
    mascot_streak: 'minutos por sesión',
    mascot_daily: 'objetivo diario',
    product_title: 'Aprender hoy es un caos.',
    product_subtitle: 'Saltas entre videos, PDFs y posts sin una ruta clara.\nConsumes contenido, pero no sabes qué practicar, si estás mejorando ni cuándo avanzar.',
    product_card1_title: 'Demasiadas fuentes',
    product_card1_body: 'Videos, documentos, hilos y cursos viven separados. Nada está conectado.',
    product_card2_title: 'No sabes qué sigue',
    product_card2_body: 'Aprendes cosas sueltas, pero no construyes dominio real.',
    product_card3_title: 'Practicas a ciegas',
    product_card3_body: 'No sabes qué reforzar ni si tu esfuerzo está dando resultados.',
    product_card4_title: 'Pierdes impulso',
    product_card4_body: 'Sin progreso visible, la mayoría abandona.',
    product_closing: 'MiniLearn transforma este caos en un camino claro de aprendizaje.',
    how_title: 'Cómo funciona en 3 pasos',
    how_subtitle: 'Del tema a un sistema de aprendizaje, en minutos.',
    how_step1_title: 'Elige un tema',
    how_step1_body: 'Define tu objetivo y tu nivel (o carga procesos para equipos).',
    how_step2_title: 'MiniLearn arma la ruta',
    how_step2_body: 'Secuencia ordenada con objetivos y cápsulas diarias.',
    how_step3_title: 'Aprende y valida progreso',
    how_step3_body: 'Evaluaciones cortas que indican qué practicar después.',
    who_title: '¿Es MiniLearn para ti?',
    who_subtitle: 'Si alguna vez quisiste aprender algo y no supiste por dónde empezar, sí.',
    who_b2c_heading: 'Aprender algo nuevo, sin perder tiempo ni foco',
    who_b2c_body: 'Quieres aprender un tema específico, pero no quieres pasar horas buscando cursos, videos o PDFs.\nMiniLearn crea una ruta clara para que avances con poco tiempo al día.',
    who_b2c_case1: 'Quiero aprender, pero no sé por dónde empezar',
    who_b2c_case2: 'Tengo poco tiempo y necesito estructura',
    who_b2c_case3: 'Quiero avanzar de verdad, no solo consumir contenido',
    who_b2c_case4: 'Quiero saber si estoy mejorando',
    who_b2c_cta: 'Empieza a aprender',
    who_b2b_heading: 'También para equipos',
    who_b2b_lead: 'Cuando el conocimiento interno no puede quedar en documentos olvidados.',
    who_b2b_body: 'MiniLearn convierte documentación y procesos internos en capacitación continua y medible para equipos.',
    who_b2b_case1: 'Onboarding más rápido',
    who_b2b_case2: 'Capacitación continua en procesos',
    who_b2b_case3: 'Playbooks de ventas o soporte',
    who_b2b_case4: 'Cumplimiento y políticas internas',
    who_b2b_cta: 'Usar MiniLearn en mi equipo',
    who_closing: 'MiniLearn empieza contigo. Luego escala a equipos.',
    cta_pill: 'Empieza ahora',
    cta_title: 'Estamos en Beta cerrada. ¡Inscríbete!',
    cta_subtitle: 'Empieza con tu objetivo y tiempo, y sigue un camino que puedes terminar.',
    cta_stat1: 'minutos por sesión',
    cta_stat2_title: 'Sin tarjeta',
    cta_stat2: 'requerida',
    form_label: 'Tu email',
    form_placeholder: 'tu@email.com',
    form_note: '',
    form_cta: 'Inscríbete',
    form_success: 'Tu ruta está en marcha. Te avisaremos con tu acceso.',
    footer_terms: 'Términos',
    footer_privacy: 'Privacidad',
    footer_contact: 'Contacto',
    footer_copy: 'MiniLearn · Infraestructura para aprender.',
    teams_back: 'Volver',
    teams_pill: 'MiniLearn para equipos',
    teams_title: 'Convierte documentación interna en capacitación continua.',
    teams_subtitle: 'MiniLearn transforma procesos, playbooks y conocimiento interno en rutas guiadas,\ncon evaluaciones y progreso medible para cada equipo, sin construir cursos desde cero.',
    teams_cta_primary: 'Habla con nosotros',
    teams_cta_secondary: 'Solicitar demo',
    teams_badge1: 'Onboarding más rápido',
    teams_badge2: 'Capacitación continua',
    teams_badge3: 'Progreso medible',
    teams_usecases_title: 'Casos típicos',
    teams_usecase1: 'Onboarding de nuevos ingresos en días, no semanas.',
    teams_usecase2: 'Playbooks de ventas y soporte con práctica guiada.',
    teams_usecase3: 'Procesos críticos y cumplimiento con evidencia de avance.',
    teams_form_title: 'Agenda una llamada',
    teams_form_subtitle: 'Cuéntanos sobre tu equipo y te mostramos una ruta de ejemplo personalizada.',
    teams_form_name: 'Nombre',
    teams_form_company: 'Empresa',
    teams_form_email: 'Email',
    teams_form_name_placeholder: 'Tu nombre',
    teams_form_company_placeholder: 'Empresa',
    teams_form_email_placeholder: 'tu@email.com',
    teams_form_cta: 'Contactar',
    teams_form_note: 'Responderemos con un ejemplo y los próximos pasos.',
    teams_form_success: 'Gracias. Te contactaremos con un ejemplo y los siguientes pasos.',
    terms_title: 'Terminos de uso',
    terms_subtitle: 'MiniLearn es una app de aprendizaje con IA. Al usarla, aceptas los siguientes terminos.',
    terms_card1_title: 'Cuenta y acceso',
    terms_card1_body: 'Debes proporcionar informacion veraz y mantener segura tu cuenta. Eres responsable del uso que se haga de ella.',
    terms_card2_title: 'Uso aceptable',
    terms_card2_body: 'No uses la app para contenido ilegal, abusivo o que infrinja derechos de terceros. Podemos suspender cuentas ante incumplimientos.',
    terms_card3_title: 'Contenido y resultados',
    terms_card3_body: 'La IA genera rutas y evaluaciones de forma automatizada. No garantizamos exactitud absoluta y recomendamos validar informacion critica.',
    terms_card4_title: 'Cambios y disponibilidad',
    terms_card4_body: 'Podemos actualizar funciones y precios. Intentaremos avisar con antelacion cuando los cambios sean relevantes.',
    privacy_title: 'Privacidad',
    privacy_subtitle: 'Respetamos tus datos y solo los usamos para operar y mejorar la experiencia.',
    privacy_card1_title: 'Datos que recopilamos',
    privacy_card1_body: 'Email, idioma, preferencias y progreso. Tambien datos tecnicos basicos para seguridad y rendimiento. No vendemos datos personales.',
    privacy_card2_title: 'Como los usamos',
    privacy_card2_body: 'Para crear tu sistema de aprendizaje, medir progreso, enviar notificaciones y mejorar la app.',
    privacy_card3_title: 'Compartir datos',
    privacy_card3_body: 'Solo con proveedores necesarios (email, analiticas, hosting) bajo acuerdos de confidencialidad. Nunca para publicidad personalizada.',
    privacy_card4_title: 'Tus derechos',
    privacy_card4_body: 'Puedes solicitar acceso, correccion o eliminacion de tus datos escribiendo a hi@minilearn.cl.',
    error_empty: 'Por favor, introduce tu email',
    error_required: 'Por favor, completa todos los campos',
    error_invalid: 'Por favor, introduce un email válido',
    error_exists: 'Tu email ya está registrado',
    error_submit: 'No pudimos enviar tu email. Intenta de nuevo en unos segundos.',
    success_announce: 'Gracias. Te avisaremos con tu acceso.',
    button_sending: 'Enviando...',
  },
  en: {
    lang_label: 'Language',
    nav_product: 'Problem',
    nav_how: 'How it works',
    nav_who: "Who it's for",
    cta_start: 'Generate your first course',
    cta_team: 'Talk to us',
    cta_team_note: 'Have a team? We can help with training.',
    hero_pill: 'Learning system builder',
    hero_title: 'The simplest way to learn anything you want',
    hero_subtitle: 'MiniLearn generates a structured learning path tailored to your goal, level, and time—then reinforces it with daily capsules and adaptive assessments.',
    cta_how: 'See how it works',
    badge_card: 'Minutes, not hours',
    badge_freemium: 'Structured for you',
    badge_weekly: 'Personalized by AI',
    mascot_streak: 'minutes per session',
    mascot_daily: 'daily goal',
    product_title: 'Learning today is chaos.',
    product_subtitle: 'You bounce between videos, PDFs, and posts with no clear route.\nYou consume content but don’t know what to practice, whether you’re improving, or when to move on.',
    product_card1_title: 'Too many sources',
    product_card1_body: 'Videos, docs, threads, and courses live apart. Nothing is connected.',
    product_card2_title: 'No sense of what’s next',
    product_card2_body: 'You learn disconnected pieces, but you don’t build real mastery.',
    product_card3_title: 'You practice blind',
    product_card3_body: 'You don’t know what to reinforce or whether your effort is working.',
    product_card4_title: 'You lose momentum',
    product_card4_body: 'Without visible progress, most people quit.',
    product_closing: 'MiniLearn turns this chaos into a clear learning path.',
    how_title: 'How it works in 3 steps',
    how_subtitle: 'From topic to a structured learning system in minutes.',
    how_step1_title: 'Choose a topic',
    how_step1_body: 'Choose a topic or upload internal docs (for teams).',
    how_step2_title: 'MiniLearn builds the path',
    how_step2_body: 'An ordered sequence with objectives and daily capsules.',
    how_step3_title: 'Learn and validate progress',
    how_step3_body: 'Short adaptive assessments show what to practice next.',
    who_title: 'Is MiniLearn for you?',
    who_subtitle: "If you've ever wanted to learn something but didn't know where to start, yes.",
    who_b2c_heading: 'Learn something new without losing time or focus',
    who_b2c_body: "You want to learn a specific topic but don't want to spend hours searching courses, videos, or PDFs.\nMiniLearn creates a clear path so you can move forward with little time each day.",
    who_b2c_case1: "I want to learn but don't know where to start",
    who_b2c_case2: 'I have little time and need structure',
    who_b2c_case3: "I want real progress, not just content consumption",
    who_b2c_case4: 'I want to know if I am improving',
    who_b2c_cta: 'Start learning',
    who_b2b_heading: 'Also for teams',
    who_b2b_lead: "When internal knowledge can't live in forgotten docs.",
    who_b2b_body: 'MiniLearn turns internal documentation and processes into continuous, measurable team training.',
    who_b2b_case1: 'Faster onboarding',
    who_b2b_case2: 'Continuous training on processes',
    who_b2b_case3: 'Sales or support playbooks',
    who_b2b_case4: 'Compliance and internal policies',
    who_b2b_cta: 'Use MiniLearn with my team',
    who_closing: 'MiniLearn starts with you. Then it scales to teams.',
    cta_pill: 'Start now',
    cta_title: 'We are in closed beta. Sign up!',
    cta_subtitle: 'Start with your goal and time, then build a path you can finish.',
    cta_stat1: 'minutes per session',
    cta_stat2_title: 'No card',
    cta_stat2: 'required',
    form_label: 'Your email',
    form_placeholder: 'you@email.com',
    form_note: '',
    form_cta: 'Sign up',
    form_success: 'Your path is in motion. We will notify you with access.',
    footer_terms: 'Terms',
    footer_privacy: 'Privacy',
    footer_contact: 'Contact',
    footer_copy: 'MiniLearn · Learning infrastructure.',
    teams_back: 'Back',
    teams_pill: 'MiniLearn for teams',
    teams_title: 'Turn internal documentation into continuous training.',
    teams_subtitle: 'MiniLearn transforms processes, playbooks, and internal knowledge into guided paths,\nwith assessments and measurable progress for every team, without building courses from scratch.',
    teams_cta_primary: 'Talk to us',
    teams_cta_secondary: 'Request a demo',
    teams_badge1: 'Faster onboarding',
    teams_badge2: 'Continuous training',
    teams_badge3: 'Measurable progress',
    teams_usecases_title: 'Typical use cases',
    teams_usecase1: 'Onboard new hires in days, not weeks.',
    teams_usecase2: 'Sales and support playbooks with guided practice.',
    teams_usecase3: 'Critical processes and compliance with proof of progress.',
    teams_form_title: 'Schedule a call',
    teams_form_subtitle: 'Tell us about your team and we will share a tailored example path.',
    teams_form_name: 'Name',
    teams_form_company: 'Company',
    teams_form_email: 'Email',
    teams_form_name_placeholder: 'Your name',
    teams_form_company_placeholder: 'Company',
    teams_form_email_placeholder: 'you@email.com',
    teams_form_cta: 'Contact',
    teams_form_note: 'We will reply with an example and next steps.',
    teams_form_success: 'Thanks. We will contact you with an example and next steps.',
    terms_title: 'Terms of use',
    terms_subtitle: 'MiniLearn is an AI learning app. By using it, you agree to the following terms.',
    terms_card1_title: 'Account and access',
    terms_card1_body: 'Provide accurate information and keep your account secure. You are responsible for activity under your account.',
    terms_card2_title: 'Acceptable use',
    terms_card2_body: 'Do not use the app for illegal, abusive, or infringing content. We may suspend accounts for violations.',
    terms_card3_title: 'Content and results',
    terms_card3_body: 'AI generates paths and assessments automatically. We do not guarantee absolute accuracy; validate critical information.',
    terms_card4_title: 'Changes and availability',
    terms_card4_body: 'We may update features and pricing. We will try to notify you in advance when changes are significant.',
    privacy_title: 'Privacy',
    privacy_subtitle: 'We respect your data and use it only to operate and improve the experience.',
    privacy_card1_title: 'Data we collect',
    privacy_card1_body: 'Email, language, preferences, and progress. Also basic technical data for security and performance. We do not sell personal data.',
    privacy_card2_title: 'How we use it',
    privacy_card2_body: 'To generate your learning system, track progress, send notifications, and improve the app.',
    privacy_card3_title: 'Data sharing',
    privacy_card3_body: 'Only with required providers (email, analytics, hosting) under confidentiality agreements. Never for personalized ads.',
    privacy_card4_title: 'Your rights',
    privacy_card4_body: 'You can request access, correction, or deletion of your data by contacting hi@minilearn.cl.',
    error_empty: 'Please enter your email',
    error_required: 'Please complete all fields',
    error_invalid: 'Please enter a valid email',
    error_exists: 'Your email is already registered',
    error_submit: 'We could not send your email. Please try again in a moment.',
    success_announce: 'Thanks. We will notify you with access.',
    button_sending: 'Sending...',
  },
};

const waitlistForm = document.getElementById('waitlist-form');
const emailInput = document.getElementById('email');
const emailError = document.getElementById('email-error');
const successMessage = document.getElementById('success-message');
const submitButton = waitlistForm?.querySelector('button[type="submit"]');
const teamsForm = document.getElementById('teams-form');
const teamsNameInput = document.getElementById('team-name');
const teamsCompanyInput = document.getElementById('team-company');
const teamsEmailInput = document.getElementById('team-email');
const teamsEmailError = document.getElementById('teams-email-error');
const teamsSuccessMessage = document.getElementById('teams-success-message');
const teamsSubmitButton = teamsForm?.querySelector('button[type="submit"]');
const langButtons = document.querySelectorAll('.lang-btn');

let emails = JSON.parse(localStorage.getItem('minilearn-waitlist')) || [];
const storedLang = localStorage.getItem('minilearn-lang');
const browserLang = (navigator.language || 'es').slice(0, 2).toLowerCase();
const params = new URLSearchParams(window.location.search);
const queryLang = params.get('lang');
const normalizedQueryLang = queryLang ? queryLang.toLowerCase() : '';
const preferredQueryLang = translations[normalizedQueryLang] ? normalizedQueryLang : '';
let currentLang = preferredQueryLang || storedLang || document.documentElement.lang || browserLang || 'es';
let submitButtonText = '';
let teamsSubmitButtonText = '';

if(!translations[currentLang]){
  currentLang = 'es';
}

function t(key){
  return translations[currentLang][key] || key;
}

function getSubmitButtonText(button){
  if(!button) return t('cta_start');
  const key = button.dataset.i18n;
  return key ? t(key) : t('cta_start');
}

function updateUrlLang(lang){
  const url = new URL(window.location.href);
  url.searchParams.set('lang', lang);
  history.replaceState({}, '', url.pathname + url.search + url.hash);
}

function updateLangLinks(lang){
  document.querySelectorAll('a[href]').forEach(link=>{
    const raw = link.getAttribute('href');
    if(!raw) return;
    if(raw.startsWith('http://') || raw.startsWith('https://') || raw.startsWith('//')) return;
    if(raw.startsWith('mailto:') || raw.startsWith('tel:') || raw.startsWith('javascript:')) return;

    const url = new URL(raw, window.location.href);
    url.searchParams.set('lang', lang);
    link.setAttribute('href', url.pathname + url.search + url.hash);
  });
}

function setLanguage(lang, options = {}){
  currentLang = translations[lang] ? lang : 'es';
  document.documentElement.lang = currentLang;
  localStorage.setItem('minilearn-lang', currentLang);

  document.querySelectorAll('[data-i18n]').forEach(el=>{
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    el.placeholder = t(el.dataset.i18nPlaceholder);
  });
  document.querySelectorAll('[data-i18n-aria]').forEach(el=>{
    el.setAttribute('aria-label', t(el.dataset.i18nAria));
  });

  langButtons.forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.lang === currentLang);
  });

  submitButtonText = getSubmitButtonText(submitButton);
  if(submitButton && !submitButton.disabled){
    submitButton.textContent = submitButtonText;
  }
  teamsSubmitButtonText = getSubmitButtonText(teamsSubmitButton);
  if(teamsSubmitButton && !teamsSubmitButton.disabled){
    teamsSubmitButton.textContent = teamsSubmitButtonText;
  }

  if(options.updateUrl){
    updateUrlLang(currentLang);
  }
  updateLangLinks(currentLang);
}

langButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> setLanguage(btn.dataset.lang, { updateUrl: true }));
});

function validateEmail(email){
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}
function showError(message, input = emailInput, errorEl = emailError){
  if(!input || !errorEl) return;
  errorEl.textContent = message;
  input.classList.add('error');
  input.setAttribute('aria-invalid','true');
}
function clearError(input = emailInput, errorEl = emailError){
  if(!input || !errorEl) return;
  errorEl.textContent = '';
  input.classList.remove('error');
  input.setAttribute('aria-invalid','false');
}

waitlistForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  clearError();

  const email = emailInput.value.trim();
  if(!email){ showError(t('error_empty')); emailInput.focus(); return; }
  if(!validateEmail(email)){ showError(t('error_invalid')); emailInput.focus(); return; }
  if(emails.includes(email)){ showError(t('error_exists')); return; }

  if(submitButton){
    submitButton.disabled = true;
    submitButton.textContent = t('button_sending');
  }

  try{
    const response = await fetch(waitlistForm.action, {
      method: 'POST',
      headers: { 'Accept': 'application/json' },
      body: new FormData(waitlistForm),
    });

    if(!response.ok){
      throw new Error('Formspree error');
    }

    emails.push(email);
    localStorage.setItem('minilearn-waitlist', JSON.stringify(emails));

    waitlistForm.style.display = 'none';
    successMessage.style.display = 'flex';
    emailInput.value = '';

    const announcement = document.createElement('div');
    announcement.setAttribute('role','status');
    announcement.setAttribute('aria-live','polite');
    announcement.textContent = t('success_announce');
    announcement.style.position = 'absolute';
    announcement.style.left = '-10000px';
    document.body.appendChild(announcement);

    successMessage.scrollIntoView({behavior:'smooth', block:'center'});
  }catch(error){
    showError(t('error_submit'));
  }finally{
    if(submitButton){
      submitButton.disabled = false;
      submitButton.textContent = submitButtonText;
    }
  }
});

emailInput?.addEventListener('input', ()=> clearError());

teamsForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  clearError(teamsEmailInput, teamsEmailError);

  const name = teamsNameInput?.value.trim();
  const company = teamsCompanyInput?.value.trim();
  const email = teamsEmailInput?.value.trim();

  if(!name){
    showError(t('error_required'), teamsNameInput, teamsEmailError);
    teamsNameInput?.focus();
    return;
  }
  if(!company){
    showError(t('error_required'), teamsCompanyInput, teamsEmailError);
    teamsCompanyInput?.focus();
    return;
  }
  if(!email){
    showError(t('error_empty'), teamsEmailInput, teamsEmailError);
    teamsEmailInput?.focus();
    return;
  }
  if(!validateEmail(email)){
    showError(t('error_invalid'), teamsEmailInput, teamsEmailError);
    teamsEmailInput?.focus();
    return;
  }

  if(teamsSubmitButton){
    teamsSubmitButton.disabled = true;
    teamsSubmitButton.textContent = t('button_sending');
  }

  try{
    const response = await fetch(teamsForm.action, {
      method: 'POST',
      headers: { 'Accept': 'application/json' },
      body: new FormData(teamsForm),
    });

    if(!response.ok){
      throw new Error('Formspree error');
    }

    teamsForm.style.display = 'none';
    teamsSuccessMessage.style.display = 'flex';
    if(teamsEmailInput){
      teamsEmailInput.value = '';
    }

    const announcement = document.createElement('div');
    announcement.setAttribute('role','status');
    announcement.setAttribute('aria-live','polite');
    announcement.textContent = t('teams_form_success');
    announcement.style.position = 'absolute';
    announcement.style.left = '-10000px';
    document.body.appendChild(announcement);

    teamsSuccessMessage.scrollIntoView({behavior:'smooth', block:'center'});
  }catch(error){
    showError(t('error_submit'), teamsEmailInput, teamsEmailError);
  }finally{
    if(teamsSubmitButton){
      teamsSubmitButton.disabled = false;
      teamsSubmitButton.textContent = teamsSubmitButtonText;
    }
  }
});

teamsEmailInput?.addEventListener('input', ()=> clearError(teamsEmailInput, teamsEmailError));
teamsNameInput?.addEventListener('input', ()=> clearError(teamsNameInput, teamsEmailError));
teamsCompanyInput?.addEventListener('input', ()=> clearError(teamsCompanyInput, teamsEmailError));

// Smooth scroll con enfoque accesible
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{
  anchor.addEventListener('click', (e)=>{
    const href = anchor.getAttribute('href');
    if(href === '#') return;
    const target = document.querySelector(href);
    if(!target) return;
    e.preventDefault();
    const headerOffset = 80;
    const elementPosition = target.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
    target.setAttribute('tabindex','-1');
    target.focus({preventScroll:true});
  });
});

setLanguage(currentLang);

// Animaciones al hacer scroll
const observer = new IntersectionObserver(entries=>{
  entries.forEach(entry=>{
    if(entry.isIntersecting){
      entry.target.classList.add('visible');
    }
  });
}, {threshold:.12, rootMargin:'0px 0px -60px 0px'});

document.querySelectorAll('.reveal')
  .forEach(el=> observer.observe(el));
